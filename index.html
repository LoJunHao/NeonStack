<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Neon Stack: High Stakes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-cyan: #00f3ff;
            --neon-purple: #bc13fe;
            --neon-pink: #ff00de;
            --neon-green: #39ff14;
        }

        body {
            background-color: #0a0a0c;
            color: #e2e8f0;
            font-family: 'Rajdhani', sans-serif;
            overflow: hidden;
            touch-action: none;
        }

        .font-orbitron { font-family: 'Orbitron', sans-serif; }

        canvas {
            image-rendering: pixelated;
            box-shadow: 0 0 20px rgba(0, 243, 255, 0.2);
            border: 2px solid rgba(0, 243, 255, 0.3);
        }

        .neon-text {
            text-shadow: 0 0 10px var(--neon-cyan);
        }

        .neon-border {
            border: 1px solid var(--neon-cyan);
            box-shadow: 0 0 10px rgba(0, 243, 255, 0.2);
        }

        .btn-glow:hover {
            box-shadow: 0 0 15px var(--neon-cyan);
            transform: translateY(-2px);
        }

        .multiplier-pulse {
            animation: pulse 1s infinite alternate;
        }

        @keyframes pulse {
            from { transform: scale(1); text-shadow: 0 0 5px var(--neon-green); }
            to { transform: scale(1.05); text-shadow: 0 0 20px var(--neon-green); }
        }

        /* Mobile Controls Layout */
        .controls-grid {
            display: grid;
            grid-template-areas: 
                ". up ."
                "left down right"
                ". rot .";
            gap: 10px;
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(0, 243, 255, 0.2);
            padding: 15px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden">

    <!-- Header / Stats Bar -->
    <header class="p-4 border-b border-white/10 flex justify-between items-center bg-black/40 backdrop-blur-md z-10">
        <div class="flex flex-col">
            <h1 class="text-xl font-orbitron font-bold text-cyan-400 tracking-wider">NEON STACK</h1>
            <span class="text-xs text-gray-400">PROVABLY FAIR RNG ACTIVE</span>
        </div>
        <div class="text-right">
            <div class="text-xs text-gray-500 uppercase">Balance</div>
            <div id="balance" class="text-xl font-orbitron text-white">$1,000.00</div>
        </div>
    </header>

    <!-- Main Game Area -->
    <main class="flex-grow relative flex flex-col md:flex-row items-center justify-center p-4 gap-6">
        
        <!-- Left Sidebar: Multiplier Info -->
        <div id="game-info" class="hidden md:flex flex-col gap-4 w-48 order-2 md:order-1">
            <div class="p-4 bg-white/5 rounded-lg border border-white/10">
                <div class="text-xs text-gray-400 mb-1">LINES</div>
                <div id="lines-cleared" class="text-2xl font-orbitron">0</div>
            </div>
            <div class="p-4 bg-white/5 rounded-lg border border-white/10">
                <div class="text-xs text-gray-400 mb-1">LEVEL</div>
                <div id="game-level" class="text-2xl font-orbitron">1</div>
            </div>
            <div class="p-4 bg-white/5 rounded-lg border border-white/10">
                <div class="text-xs text-gray-400 mb-1">NEXT PIECE</div>
                <canvas id="next-piece-canvas" width="80" height="80" class="mx-auto mt-2 bg-black/30 border-none shadow-none"></canvas>
            </div>
        </div>

        <!-- Center: Game Board -->
        <div class="relative order-1 md:order-2">
            <canvas id="tetris" width="240" height="480" class="rounded-sm"></canvas>
            
            <!-- Overlay Screens -->
            <div id="overlay" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center p-6 text-center">
                <div id="lobby-screen" class="space-y-6">
                    <h2 class="text-3xl font-orbitron text-cyan-400 neon-text">PLACE YOUR STAKE</h2>
                    <div class="flex flex-col gap-2">
                        <label class="text-sm text-gray-400">Wager Amount</label>
                        <input type="number" id="bet-input" value="10" min="1" step="1" 
                               class="bg-white/10 border border-cyan-500/50 rounded-lg p-3 text-2xl font-orbitron text-center focus:outline-none focus:ring-2 ring-cyan-500">
                    </div>
                    <button onclick="startGame()" class="w-full py-4 bg-cyan-600 hover:bg-cyan-500 text-white font-bold font-orbitron rounded-lg transition-all btn-glow">
                        START STACKING
                    </button>
                    <p class="text-xs text-gray-500 italic max-w-xs">Clear lines to increase your multiplier. Top out and lose it all. Cash out at any time.</p>
                </div>

                <div id="game-over-screen" class="hidden space-y-4">
                    <h2 class="text-4xl font-orbitron text-red-500">TOPPED OUT</h2>
                    <p class="text-xl">STAKE LOST: <span id="lost-amount" class="text-red-400">$-10.00</span></p>
                    <button onclick="resetToLobby()" class="px-8 py-3 bg-white/10 hover:bg-white/20 rounded-lg font-orbitron transition-all">
                        TRY AGAIN
                    </button>
                </div>

                <div id="cashed-out-screen" class="hidden space-y-4">
                    <h2 class="text-4xl font-orbitron text-green-400">CASHED OUT!</h2>
                    <div class="text-5xl font-orbitron text-white mb-2" id="win-amount">$50.00</div>
                    <p class="text-gray-400">Multiplier reached: <span id="final-mult">5.0x</span></p>
                    <button onclick="resetToLobby()" class="px-8 py-3 bg-green-600 hover:bg-green-500 rounded-lg font-orbitron transition-all btn-glow">
                        COLLECT
                    </button>
                </div>
            </div>
        </div>

        <!-- Right Sidebar: Live Payout -->
        <div id="payout-panel" class="w-full md:w-64 flex flex-col gap-4 order-3">
            <div class="p-6 bg-cyan-900/20 rounded-xl border-2 border-cyan-500/30 flex flex-col items-center">
                <div class="text-sm text-cyan-400 mb-2 uppercase tracking-widest">Live Multiplier</div>
                <div id="multiplier-display" class="text-5xl font-orbitron text-green-400 multiplier-pulse">1.00x</div>
                
                <div class="w-full h-px bg-white/10 my-4"></div>
                
                <div class="text-sm text-gray-400 mb-1">CASH OUT VALUE</div>
                <div id="cashout-value" class="text-3xl font-orbitron text-white">$10.00</div>
                
                <button id="cashout-btn" onclick="cashOut()" disabled 
                        class="w-full mt-6 py-4 bg-green-600 disabled:bg-gray-700 disabled:opacity-50 text-white font-bold font-orbitron rounded-xl text-xl transition-all shadow-lg">
                    CASH OUT
                </button>
            </div>

            <!-- Mobile Touch Controls -->
            <div class="md:hidden grid grid-cols-3 gap-2 mt-4 max-w-[240px] mx-auto">
                <button onpointerdown="move(-1)" class="control-btn"><svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6 1.41-1.41z"/></svg></button>
                <button onpointerdown="rotate()" class="control-btn"><svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg></button>
                <button onpointerdown="move(1)" class="control-btn"><svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6-1.41-1.41z"/></svg></button>
                <div class="col-start-2">
                    <button onpointerdown="dropFast(true)" onpointerup="dropFast(false)" class="control-btn w-full"><svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M7.41 7.84L12 12.42l4.59-4.58L18 9.25l-6 6-6-6 1.41-1.41z"/></svg></button>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- CONSTANTS & CONFIG ---
        const canvas = document.getElementById('tetris');
        const context = canvas.getContext('2d');
        const nextCanvas = document.getElementById('next-piece-canvas');
        const nextCtx = nextCanvas.getContext('2d');
        
        const COLS = 10;
        const ROWS = 20;
        const BLOCK_SIZE = 24;
        
        const COLORS = [
            null,
            '#00f3ff', // I - Cyan
            '#ff00de', // J - Pink/Purple
            '#ff8a00', // L - Orange
            '#f7ff00', // O - Yellow
            '#39ff14', // S - Green
            '#bc13fe', // T - Purple
            '#ff003c', // Z - Red
        ];

        const SHAPES = [
            null,
            [[0, 0, 0, 0], [1, 1, 1, 1], [0, 0, 0, 0], [0, 0, 0, 0]], // I
            [[2, 0, 0], [2, 2, 2], [0, 0, 0]], // J
            [[0, 0, 3], [3, 3, 3], [0, 0, 0]], // L
            [[4, 4], [4, 4]], // O
            [[0, 5, 5], [5, 5, 0], [0, 0, 0]], // S
            [[0, 6, 0], [6, 6, 6], [0, 0, 0]], // T
            [[7, 7, 0], [0, 7, 7], [0, 0, 0]], // Z
        ];

        // --- GAME STATE ---
        let board = createMatrix(COLS, ROWS);
        let player = {
            pos: {x: 0, y: 0},
            matrix: null,
            next: null,
            score: 0,
            lines: 0,
            level: 1,
            multiplier: 1.0,
            stake: 10,
        };

        let dropCounter = 0;
        let dropInterval = 1000;
        let lastTime = 0;
        let isGameOver = false;
        let isPlaying = false;
        let userBalance = 1000;
        let isFastDrop = false;

        // --- CORE ENGINE ---
        function createMatrix(w, h) {
            const matrix = [];
            while (h--) matrix.push(new Array(w).fill(0));
            return matrix;
        }

        function draw() {
            // Background
            context.fillStyle = '#111';
            context.fillRect(0, 0, canvas.width, canvas.height);

            // Grid lines
            context.strokeStyle = 'rgba(255, 255, 255, 0.03)';
            for(let i=0; i<COLS; i++) {
                context.beginPath();
                context.moveTo(i * BLOCK_SIZE, 0);
                context.lineTo(i * BLOCK_SIZE, canvas.height);
                context.stroke();
            }
            for(let i=0; i<ROWS; i++) {
                context.beginPath();
                context.moveTo(0, i * BLOCK_SIZE);
                context.lineTo(canvas.width, i * BLOCK_SIZE);
                context.stroke();
            }

            drawMatrix(board, {x: 0, y: 0});
            drawMatrix(player.matrix, player.pos);
            drawGhost();
        }

        function drawMatrix(matrix, offset, ctx = context, scale = BLOCK_SIZE) {
            matrix.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value !== 0) {
                        ctx.fillStyle = COLORS[value];
                        // Outer block
                        ctx.fillRect((x + offset.x) * scale, (y + offset.y) * scale, scale, scale);
                        // Neon highlight
                        ctx.strokeStyle = 'rgba(255,255,255,0.5)';
                        ctx.lineWidth = 1;
                        ctx.strokeRect((x + offset.x) * scale + 1, (y + offset.y) * scale + 1, scale - 2, scale - 2);
                    }
                });
            });
        }

        function drawGhost() {
            const ghost = {
                pos: {x: player.pos.x, y: player.pos.y},
                matrix: player.matrix
            };
            while (!collide(board, ghost)) {
                ghost.pos.y++;
            }
            ghost.pos.y--;
            
            context.globalAlpha = 0.15;
            drawMatrix(ghost.matrix, ghost.pos);
            context.globalAlpha = 1;
        }

        function drawNext() {
            nextCtx.fillStyle = '#111';
            nextCtx.fillRect(0, 0, nextCanvas.width, nextCanvas.height);
            const matrix = player.next;
            const offsetX = (nextCanvas.width / 20 - matrix[0].length / 2);
            const offsetY = (nextCanvas.height / 20 - matrix.length / 2);
            drawMatrix(matrix, {x: offsetX, y: offsetY}, nextCtx, 20);
        }

        function collide(board, player) {
            const [m, o] = [player.matrix, player.pos];
            for (let y = 0; y < m.length; ++y) {
                for (let x = 0; x < m[y].length; ++x) {
                    if (m[y][x] !== 0 && (board[y + o.y] && board[y + o.y][x + o.x]) !== 0) {
                        return true;
                    }
                }
            }
            return false;
        }

        function merge(board, player) {
            player.matrix.forEach((row, y) => {
                row.forEach((value, x) => {
                    if (value !== 0) {
                        board[y + player.pos.y][x + player.pos.x] = value;
                    }
                });
            });
        }

        function rotateMatrix(matrix, dir) {
            for (let y = 0; y < matrix.length; ++y) {
                for (let x = 0; x < y; ++x) {
                    [matrix[x][y], matrix[y][x]] = [matrix[y][x], matrix[x][y]];
                }
            }
            if (dir > 0) matrix.forEach(row => row.reverse());
            else matrix.reverse();
        }

        function playerDrop() {
            player.pos.y++;
            if (collide(board, player)) {
                player.pos.y--;
                merge(board, player);
                playerReset();
                arenaSweep();
                updateUI();
            }
            dropCounter = 0;
        }

        function playerMove(dir) {
            player.pos.x += dir;
            if (collide(board, player)) {
                player.pos.x -= dir;
            }
        }

        function playerRotate(dir) {
            const pos = player.pos.x;
            let offset = 1;
            rotateMatrix(player.matrix, dir);
            while (collide(board, player)) {
                player.pos.x += offset;
                offset = -(offset + (offset > 0 ? 1 : -1));
                if (offset > player.matrix[0].length) {
                    rotateMatrix(player.matrix, -dir);
                    player.pos.x = pos;
                    return;
                }
            }
        }

        function arenaSweep() {
            let rowCount = 0;
            outer: for (let y = board.length - 1; y > 0; --y) {
                for (let x = 0; x < board[y].length; ++x) {
                    if (board[y][x] === 0) continue outer;
                }
                const row = board.splice(y, 1)[0].fill(0);
                board.unshift(row);
                ++y;
                rowCount++;
            }
            
            if (rowCount > 0) {
                calculateMultiplier(rowCount);
            }
        }

        function calculateMultiplier(lines) {
            // Gambling Logic: Multipliers for line clears
            const bonusMap = {
                1: 0.10, // Single
                2: 0.35, // Double
                3: 0.85, // Triple
                4: 2.50  // TETRIS
            };
            
            player.lines += lines;
            player.multiplier += bonusMap[lines] || 0;
            
            // Level up speed
            player.level = Math.floor(player.lines / 10) + 1;
            dropInterval = Math.max(100, 1000 - (player.level - 1) * 100);
            
            updateUI();
        }

        function playerReset() {
            if (!player.next) {
                player.next = SHAPES[Math.floor(Math.random() * (SHAPES.length - 1)) + 1];
            }
            player.matrix = player.next;
            player.next = SHAPES[Math.floor(Math.random() * (SHAPES.length - 1)) + 1];
            player.pos.y = 0;
            player.pos.x = (board[0].length / 2 | 0) - (player.matrix[0].length / 2 | 0);
            
            if (collide(board, player)) {
                gameOver();
            }
            drawNext();
        }

        // --- GAME CONTROL ---
        function update(time = 0) {
            if (!isPlaying || isGameOver) return;

            const deltaTime = time - lastTime;
            lastTime = time;

            dropCounter += deltaTime;
            const currentInterval = isFastDrop ? 30 : dropInterval;

            if (dropCounter > currentInterval) {
                playerDrop();
            }

            draw();
            requestAnimationFrame(update);
        }

        function startGame() {
            const stake = parseFloat(document.getElementById('bet-input').value);
            if (isNaN(stake) || stake <= 0 || stake > userBalance) {
                showToast("Invalid stake or insufficient balance");
                return;
            }

            userBalance -= stake;
            player.stake = stake;
            player.multiplier = 1.0;
            player.lines = 0;
            player.level = 1;
            board = createMatrix(COLS, ROWS);
            
            isGameOver = false;
            isPlaying = true;
            document.getElementById('overlay').classList.add('hidden');
            document.getElementById('cashout-btn').disabled = false;
            
            playerReset();
            updateUI();
            requestAnimationFrame(update);
        }

        function cashOut() {
            if (!isPlaying || isGameOver) return;
            
            const win = player.stake * player.multiplier;
            userBalance += win;
            isPlaying = false;
            
            document.getElementById('overlay').classList.remove('hidden');
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('cashed-out-screen').classList.remove('hidden');
            
            document.getElementById('win-amount').innerText = `$${win.toFixed(2)}`;
            document.getElementById('final-mult').innerText = `${player.multiplier.toFixed(2)}x`;
            
            updateUI();
        }

        function gameOver() {
            isGameOver = true;
            isPlaying = false;
            
            document.getElementById('overlay').classList.remove('hidden');
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('cashed-out-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.remove('hidden');
            document.getElementById('lost-amount').innerText = `-$${player.stake.toFixed(2)}`;
            
            updateUI();
        }

        function resetToLobby() {
            document.getElementById('lobby-screen').classList.remove('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            document.getElementById('cashed-out-screen').classList.add('hidden');
            document.getElementById('cashout-btn').disabled = true;
        }

        function updateUI() {
            document.getElementById('balance').innerText = `$${userBalance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('multiplier-display').innerText = `${player.multiplier.toFixed(2)}x`;
            document.getElementById('cashout-value').innerText = `$${(player.stake * player.multiplier).toFixed(2)}`;
            document.getElementById('lines-cleared').innerText = player.lines;
            document.getElementById('game-level').innerText = player.level;
        }

        function showToast(msg) {
            const t = document.createElement('div');
            t.className = "fixed top-24 left-1/2 -translate-x-1/2 bg-red-600 px-6 py-2 rounded-full font-bold shadow-xl z-50";
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 2000);
        }

        // --- INPUTS ---
        document.addEventListener('keydown', event => {
            if (!isPlaying) return;
            if (event.keyCode === 37) playerMove(-1);
            else if (event.keyCode === 39) playerMove(1);
            else if (event.keyCode === 40) isFastDrop = true;
            else if (event.keyCode === 38) playerRotate(1);
            else if (event.keyCode === 81) playerRotate(-1);
            else if (event.keyCode === 87) playerRotate(1);
            else if (event.keyCode === 32) cashOut(); // Space to cash out
        });

        document.addEventListener('keyup', event => {
            if (event.keyCode === 40) isFastDrop = false;
        });

        // Touch Helpers
        function move(d) { playerMove(d); }
        function rotate() { playerRotate(1); }
        function dropFast(v) { isFastDrop = v; }

        // Prevent scrolling on mobile
        window.addEventListener('scroll', (e) => e.preventDefault(), { passive: false });

        // Initial setup
        updateUI();
        draw(); // Draw empty board
    </script>
</body>
</html>
